<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chat</title>
</head>

<body>

<h3 id="title"></h3>

<div id="c" style="height:300px;overflow:auto;border:1px solid black;margin-bottom:10px"></div>

<input id="m" placeholder="message">
<button onclick="s()">Send</button>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
const c = document.getElementById("c");
const m = document.getElementById("m");

const to = new URLSearchParams(location.search).get("user");
const from = localStorage.user;

document.getElementById("title").innerText = "Chat with " + to;

const chatId = [from,to].sort().join("-");

const sok = io(location.origin);

// старые сообщения
fetch("/messages/"+chatId)
.then(r=>r.json())
.then(d=>{
  d.forEach(x=>{
    c.innerHTML += `<p><b>${x.from}:</b> ${x.text}</p>`;
  });
});

// новые
sok.on(chatId,x=>{
  c.innerHTML += `<p><b>${x.from}:</b> ${x.text}</p>`;
});

function s(){
  if(!m.value)return;
  sok.emit("send",{from,to,text:m.value});
  m.value="";
}
</script>

</body>
</html>
